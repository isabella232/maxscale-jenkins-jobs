- job:
    name: destroy
    description: 'View: axilary. This job destroys test setup'
    parameters:
      - !include: './maxscale_jobs/include/name.yaml'
      - !include: './maxscale_jobs/include/do_not_destroy_vm.yaml'
      - !include: './maxscale_jobs/include/slave.yaml'    
    builders:
      - shell: | 
          if [ $do_not_destroy_vm == "yes" ]; then
            echo "Config marked as undestroyable, exiting"
            exit 1
          fi
          if [ $try_already_running == "yes" ]; then
            echo "Config uses permanent VM, exiting"
            exit 1
          fi
      - shell: |
          if [ -d "$MDBCI_VM_PATH/$name" ]; then
            cd $MDBCI_VM_PATH/$name
            vagrant destroy -f
            if [ "$?" -eq "1" ]; then
              ../scripts/clean_vms.sh ${name}
            fi
            cd ..
            rm -rf "$MDBCI_VM_PATH/$name"
            rm -rf "$MDBCI_VM_PATH/$name"_network_config*
            rm -rf "$MDBCI_VM_PATH/$name".json
          else
            echo "Directory $MDBCI_VM_PATH/$name does not exist. Probably this job was called before $name configuration had created."
          fi 
