- job:
    name: build_and_performance_test
    project-type: pipeline
    description: 'View: build. This job build and run performance test.'
    parameters: 
      - !include: './maxscale_jobs/include/versions_incl.yaml'
      - !include: './maxscale_jobs/include/source.yaml'
      - !include: './maxscale_jobs/include/target.yaml'
      - !include: './maxscale_jobs/include/build_experimental.yaml'
      - !include: './maxscale_jobs/include/cmake_flags_release.yaml'
      - !include: './maxscale_jobs/include/try_already_running.yaml'
      - !include: './maxscale_jobs/include/do_not_destroy_vm.yaml'
      - !include: './maxscale_jobs/include/slave_perf.yaml'
    properties:
      - throttle:
          option: project
          max-per-node: 1
          max-total: 5
          enabled: true
    dsl: |
      pipeline {
        agent any          
        stages {
          stage('Build and performance test') {
            stage('Build') {
              steps {
                script {
                  def myparams = currentBuild.rawBuild.getAction(ParametersAction).getParameters()
                  build job: 'build', parameters: myparams, block: true
                }   
              }
            }
            
            stage('Performance Test') {
              steps {
                script {
                  def myparams = currentBuild.rawBuild.getAction(ParametersAction).getParameters()
                  myparams = myparams + [string(name: 'test_branch', value: params.scm_source)]
                  build job: 'performance_test_demo', parameters: myparams, block: true
                }   
              }
            }                
          }
        }
      }
    wrappers:
      - !include: './maxscale_jobs/include/workspace-cleanup.yaml'
